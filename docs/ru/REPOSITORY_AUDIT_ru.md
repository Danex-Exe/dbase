# Аудит репозитория `dbase`

Ниже — краткий технический аудит текущего состояния библиотеки с приоритизацией проблем и предложений по улучшению.

## Что уже хорошо

- Есть базовая упаковка через `pyproject.toml` и декларативные метаданные проекта.
- Поддерживаются несколько версий Python (3.8–3.12).
- Реализована i18n-модель сообщений (`eng`/`ru`) и есть документация на двух языках.

## Ключевые недостатки

### 1) Нет автоматических тестов (критично)

- В `pyproject.toml` настроен `pytest` с `testpaths = ["tests"]`, но директории/файлов тестов нет.
- Это увеличивает риск регрессий, особенно с большим числом dunder-методов в `DataBase`.

**Рекомендации:**
- Добавить минимальный unit test suite:
  - создание/чтение/обновление/удаление значений;
  - загрузка из файла;
  - поведение `clear`, `update`, `pop`, `get`;
  - проверка запретов на protected-имена;
  - временная БД (`is_temp=True`) и cleanup.
- Добавить в CI обязательный запуск `pytest`.

### 2) Некорректная семантика отсутствующих атрибутов (высокий)

- `DataBase.__getattr__` возвращает `None` для несуществующего публичного атрибута вместо `AttributeError`.
- Из-за этого ломается ожидаемое поведение Python-инструментов (`hasattr`, introspection), и код может скрывать ошибки опечаток в ключах.

**Рекомендации:**
- Сменить поведение на `raise AttributeError(...)`.
- Для API «верни `None` если нет ключа» использовать только `get()` и/или `__getitem__` с явной политикой.
- После изменения добавить migration note в changelog.

### 3) Сложная и хрупкая логика в `__setattr__` (высокий)

- Используется `inspect.currentframe()` для попытки различать внутренние/внешние присваивания protected-атрибутов.
- Это добавляет накладные расходы и потенциально нестабильно между рантаймами/инструментами.

**Рекомендации:**
- Упростить: внутренние присваивания делать через `object.__setattr__`, внешние валидировать в публичных методах.
- Сфокусироваться на предсказуемом контракте вместо динамического анализа стека.

### 4) Сохранение данных неатомарно и без блокировок (высокий)

- `_save_data()` пишет прямо в открытый файл.
- При падении процесса/конкурентной записи возможна порча JSON.

**Рекомендации:**
- Внедрить atomic write (запись во временный файл + `os.replace`).
- Добавить file-locking (хотя бы опционально) для многопроцессного сценария.

### 5) Управление временными файлами (средний)

- Для `is_temp=True` используется `NamedTemporaryFile(delete=False)`, но явной очистки файла при завершении нет.

**Рекомендации:**
- Реализовать удаление temp-файла в `__exit__`/`close` (с флагом opt-out при необходимости).
- Добавить отдельный API `close()` и поддерживать его в документации.

### 6) Документация частично расходится с реальным контрактом (средний)

- В docs есть примеры «словари как вложенные объекты» (`config.database.host`), но такие сценарии могут быть неоднозначны и вводить в заблуждение.
- Не описаны edge cases: сериализация не-JSON-типов, поведение при битом JSON, конкурентный доступ.

**Рекомендации:**
- Явно описать контракт данных (разрешённые типы, стратегия fallback).
- Добавить раздел «Ограничения» и «Потокобезопасность/процессы».
- Синхронизировать примеры с гарантированно поддерживаемыми сценариями.

### 7) Структура импортов и качество кода (средний)

- Используются wildcard-like паттерны через `_imports.py`, что снижает прозрачность зависимостей.
- В коде есть неиспользуемые переменные и широкие `except Exception` без достаточной диагностики.

**Рекомендации:**
- Перейти на явные импорты в модулях.
- Минимизировать broad-except, логировать контекст ошибок структурированно.
- Включить линтинг в CI (`flake8`/`ruff`, `mypy`).

### 8) `requirements.txt` для runtime некорректен (средний)

- `requirements.txt` содержит `python>=3.8`, что не является валидной pip-зависимостью для runtime.

**Рекомендации:**
- Очистить runtime requirements (или оставить пустым, если зависимостей нет).
- Ограничения версии Python оставлять в `pyproject.toml` (`requires-python`).

## Приоритизированный план улучшений

### Итерация 1 (быстрые и критичные)
1. Добавить тестовый каркас + базовые unit-тесты.
2. Исправить `__getattr__` (возврат `AttributeError`).
3. Внедрить atomic save.
4. Настроить CI на `pytest` + линтинг.

### Итерация 2 (надёжность API)
1. Упростить логику `__setattr__` без анализа стек-фреймов.
2. Ввести явный `close()` и cleanup temp-файлов.
3. Уточнить и синхронизировать документацию с фактическим поведением.

### Итерация 3 (DX и поддерживаемость)
1. Рефактор импортов (без `_imports`-аггрегатора).
2. Повысить покрытие тестами на edge-cases.
3. Добавить benchmark/smoke тест на объёмные JSON-файлы.

## Ожидаемый эффект от изменений

- Снижение вероятности поломок при релизах.
- Более предсказуемое поведение API для пользователей.
- Повышение надёжности при реальной файловой эксплуатации.
- Упрощение сопровождения и внесения вклада в проект.
